---
title: "Grupos de rivais do Brasil"
output:
    html_document:
        code_folding: hide
        theme: flatly
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(cluster)
library(plotly)
library(ggdendro)
library(ggfortify)
library(broom)

source(here::here("code/lib.R"))
source(here("code/plota_solucoes_hclust.R"))

theme_set(theme_bw())

knitr::opts_chunk$set(tidy = FALSE,
                      fig.width = 6,
                      fig.height = 5,
                      echo = TRUE)

paleta = c("#404E4D",
           "#92DCE5",
           "#938BA1",
           "#2D3142",
           "#F4743B")
```

```{r}
games = read_csv(here("data/international-football.csv"))
```

# Preparando os dados

```{r}
jogos_brasil = games %>% 
    filter(home_team == "Brazil" | away_team == "Brazil") %>% 
    mutate(time1 = "Brazil", 
           time2 = if_else(home_team == "Brazil", away_team, home_team), 
           score1 = if_else(home_team == "Brazil", home_score, away_score),
           score2 = if_else(home_team == "Brazil", away_score, home_score) 
    ) 

historicos = jogos_brasil %>% 
    group_by(time2) %>% 
    summarise(
        jogos = n(),
        ganhou = sum(score1 > score2) / n(), 
        empatou = sum(score1 == score2) / n(),
        perdeu = sum(score1 < score2) / n()
        )
```

# GAP

```{r}
plot_clusgap = function(clusgap, title="Gap Statistic calculation results"){
    require("ggplot2")
    gstab = data.frame(clusgap$Tab, k=1:nrow(clusgap$Tab))
    p = ggplot(gstab, aes(k, gap)) + geom_line() + geom_point(size=5)
    p = p + geom_errorbar(aes(ymax=gap+SE.sim, ymin=gap-SE.sim), width = .2)
    p = p + ggtitle(title)
    return(p)
}

log_historico <- historicos %>% 
                  mutate(jogos.log = log10(jogos))

gaps <- log_historico %>% 
    select(jogos.log, ganhou, perdeu, empatou) %>% 
    mutate_all(scale) %>% 
    clusGap(FUN = kmeans, nstart = 20, K.max = 8)

plot_clusgap(gaps)
```

# K-Means (Autoplot)

```{r}

log_historico <- historicos %>% 
                  mutate(jogos.log = log10(jogos))

features <- c('jogos.log', 'ganhou', 'perdeu', 'empatou')
n_clusters <- 4
jogos_clusters <- kmeans(log_historico[, features], n_clusters, nstart = 20)

autoplot(jogos_clusters, data = log_historico, frame = TRUE)

```

```{r}
log_historico$cluster <- factor(jogos_clusters$cluster)

log_historico %>%
      ggplot(aes(x = jogos,
                 y = empatou,
                 size = ganhou,
                 alpha = 1 - perdeu,
                 label = time2,
                 color = cluster)) +
      geom_jitter() +
      scale_x_log10()
```

